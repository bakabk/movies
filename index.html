<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
    <title>movies</title>
    <script type="text/javascript" src="./js/xmlhttprequest.js"></script>
    <link rel="stylesheet" type="text/css" href="./css/style.css">
</head>

<body>
    <div class="wrapper">
        <section class="form clearfix">
            <div class="form__tittle">Добавление фильма</div>
            <form name="save__movie">
                <input type="text" name="movie_title" class="form__movie_tittle" placeholder="Название фильма">
                <select name="movie_genre" class="form__movie_genre">
                    <option>Жанр</option>
                    <option>Фэнтэзи</option>
                </select>
                <select name="movie_year" class="form__movie_year">
                    <option>Год</option>
                    <option>2001</option>
                </select>
                <div class="form__movie_rate">
                    <div class="form__movie_text">Рейтинг</div>
                    <div class="rate_background">
                        <div class="rate_bar"></div>
                    </div>
                </div>
                <div id="rate"></div>
                <input type="button" class="form__movie_submit" value="Сохранить">
            </form>
        </section>

        <section class="table__movies">
        <input type="text" name="search-field" class="search-field" width="80%">
            <table id="table__grid">
                <thead>
                    <tr>
                        <th data-type="string">Наименование</th>
                        <th data-type="string">Жанр</th>
                        <th data-type="number">Год</th>
                        <th data-type="rate">Рейтинг</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>
    </div>
    <script type="text/javascript">
    var grid = document.getElementById('table__grid');
    var search_field = document.querySelector('.search-field');
    var rate;
    var MOVIES = [];

//     var MOVIES = [
//         {
//             id: 1,
//             movie_title: 'Властелин колец',
//             movie_genre: 'фэнтези',
//             movie_year: 2001,
//             movie_rate: 4
//         }, {
//             id: 2,
//             movie_title: 'Матрица',
//             movie_genre: 'боевик',
//             movie_year: 1999,
//             movie_rate: 5
//         }
//     ];
// ///////////////////////////////////////////////////////
// fillTableMovies(MOVIES);

function fillTableMovies(ObjMovies){
var tbody = grid.getElementsByTagName('tbody')[0];
    grid.removeChild(tbody);
    tbody.innerHTML = '';

    ObjMovies.forEach( function(element, index) {
        tbody.innerHTML += '<tr>'+
        '<td>'+element['movie_title']+'</td>'+
        '<td>'+element['movie_genre']+'</td>'+
        '<td>'+element['movie_year']+'</td>'+
        '<td class="table__grid__rate_background" data-movie_rate="'+element['movie_rate']+'">'+
        '<div class="table__grid__rate_bar" style="width:'+element['movie_rate']*20+'%'+'"></div></td></tr>';
    });

    grid.appendChild(tbody);
};
    ///////////////////////////////////////////////////////

    var rate_background = document.querySelector('.rate_background');

    rate_background.onclick = set_rate;

    function set_rate(e) {
        e = e || window.event;
        var el = e.currentTarget;

        var coordEl = el.getBoundingClientRect();
        var coordClick = e.clientX - coordEl.left;
        rate = Math.ceil(coordClick / el.clientWidth * 5);

        el.children[0].style.width = rate * 20 + '%';
        drawRate(rate, el);
    }

    function drawRate(rate, element){
        element.children[0].style.width = rate * 20 + '%';
    }


    ///////////////////////////////////////////////////////
        grid.onclick = function(e) {
            if (e.target.tagName != 'TH') return;

            // Если TH -- сортируем
            sortGrid(e.target.cellIndex, e.target.getAttribute('data-type'));
        };

        function sortGrid(colNum, type) {
            var tbody = grid.getElementsByTagName('tbody')[0];

            // Составить массив из TR
            var rowsArray = [].slice.call(tbody.rows);

            // определить функцию сравнения, в зависимости от типа
            var compare;

            switch (type) {
                case 'number':
                    compare = function(rowA, rowB) {
                        return rowA.cells[colNum].innerHTML - rowB.cells[colNum].innerHTML;
                    };
                    break;
                case 'string':
                    compare = function(rowA, rowB) {
                        return rowA.cells[colNum].innerHTML > rowB.cells[colNum].innerHTML ? 1 : -1;
                    };
                    break;
                case 'rate':
                    compare = function(rowA, rowB) {
                        return rowA.cells[colNum].dataset.movie_rate > rowB.cells[colNum].dataset.movie_rate ? 1 : -1;
                    };
                    break;
            }

            // сортировать
            rowsArray.sort(compare);

            // Убрать tbody из большого DOM документа для лучшей производительности
            grid.removeChild(tbody);

            // добавить результат в нужном порядке в TBODY
            // они автоматически будут убраны со старых мест и вставлены в правильном порядке
            for (var i = 0; i < rowsArray.length; i++) {
                tbody.appendChild(rowsArray[i]);
            }

            grid.appendChild(tbody);

        }
        ////////////////////////////////////////////////////////


  function filterMovies() {
    var searchQuery = search_field.value.toLowerCase();

    var displayMovies = MOVIES.filter(function(index){
        var searchValue = index.movie_title.toLowerCase();

        return searchValue.indexOf(searchQuery) !== -1;
    });

    fillTableMovies(displayMovies);
  }

  search_field.onkeyup = search_field.oninput = filterMovies;
  search_field.oninput = filterMovies;
  search_field.onpropertychange = function() {
    if (event.propertyName == "value") filterMovies();
  }
  filterMovies.oncut = function() {
    setTimeout(filterMovies, 0); // на момент oncut значение еще старое
  };
////////////////////////////////////////////////////////
var saveMovie = document.forms.save__movie;
var buttonSubmit = document.querySelector('.form__movie_submit');
var form__movie_text = document.querySelector('.form__movie_text');

buttonSubmit.onclick = function(e){
    var validete = 0;
        saveMovie.elements.movie_title.style.borderColor = '';
        saveMovie.elements.movie_genre.style.borderColor = '';
        saveMovie.elements.movie_year.style.borderColor = '';
        form__movie_text.style.color = '';

    if (!saveMovie.elements.movie_title.value){
        validete = 1
        saveMovie.elements.movie_title.style.borderColor = 'red';
    };

    if (saveMovie.elements.movie_genre.value == 'Жанр'){
        validete = 1
        saveMovie.elements.movie_genre.style.borderColor = 'red';
    }
    if (saveMovie.elements.movie_year.value == 'Год'){
        validete = 1
        saveMovie.elements.movie_year.style.borderColor = 'red';
    }
    if (!rate){
        validete = 1
        form__movie_text.style.color = 'red';
    }

    if (!validete) {
        var formReady = {
            movie_title: saveMovie.elements.movie_title.value,
            movie_genre: saveMovie.elements.movie_genre.value,
            movie_year: saveMovie.elements.movie_year.value,
            movie_rate: rate,
        };

        // console.log(formReady);

            saveMovie.elements.movie_title.value = null;
            saveMovie.elements.movie_genre.value = saveMovie.elements.movie_genre.options[0].value;
            saveMovie.elements.movie_year.value = saveMovie.elements.movie_year.options[0].value;
            rate = null;

            drawRate(rate, rate_background);

            /////////////////////////
            requestMovie(formReady);

            fillTableMovies(MOVIES);
    };
};
////////////////////////////////////////////////////////

    function request(callback, obj){
        var req = getXmlHttpRequest();
        req.onreadystatechange = function(){
            if (req.readyState != 4) return;
                var responseText = String(req.responseText);

                callback(responseText);
            };
        req.open(obj.method, obj.url, true);
        req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        req.send(obj.send);
    };

////////////////////////////////////////////////////////

function requestMovie(data){
    var ticket = {
        request: 'read_db_movies',
        data: 0
    };

    if (data) ticket.data = data;

    var json = JSON.stringify(ticket);
    // console.log(json);

    var requestObj = {send : json, url : 'https://nado.pp.ua/filiatix/movies.php:8080', method : 'POST'};

    request(testReq, requestObj);

    function testReq(text){
        var data = JSON.parse(text);

        MOVIES = data;

        fillTableMovies(MOVIES);
        // console.log(data);
    };
};

requestMovie();
    </script>
</body>

</html>
